# 氛围灯交互逻辑文档

本文档描述了 CKCP LAMP 氛围灯模块的交互逻辑、状态管理和指令同步机制。

## 1. 状态持久化 (记忆功能)
应用程序会在每次更改设置时，自动将用户最后选择的设置保存到本地存储 (`SharedPreferences`)。
- **存储键名**: `light_state_v1`
- **保存的数据**:
  - 开关状态 (开/关/跟随)
  - 当前模式 (单色/多色/律动)
  - RGB 颜色
  - 亮度 (总亮度及各分区亮度)
  - 主题选择 (多色主题 & 律动预设)
  - 功能开关 (分区模式、动态模式、同步模式)

**行为表现**: 当应用重新启动时，会立即加载这些设置，确保 UI 界面与用户上次的使用状态保持一致。

## 2. 连接同步 (Sync on Connection)
当蓝牙设备成功连接时，应用会触发 `syncToDevice()` 序列，以确保硬件状态与 App UI 状态一致。

**同步序列**:
1.  **开关状态**: 发送 `CMD_LIGHT_SWITCH` (0x04)
2.  **分区配置**: 发送 `CMD_ZONE_BRIGHTNESS_SWITCH` (0x02)
3.  **亮度同步**: 发送 `CMD_BRIGHTNESS` (0x03)
    - 若开启分区模式: 依次发送 分区1、分区2、分区3 的亮度。
    - 若关闭分区模式: 发送 总亮度。
4.  **模式同步**: 根据当前模式 (单色/多色/律动) 执行相应的初始化逻辑。

## 3. 模式交互逻辑

### A. 单色模式 (Mode 0)
- **选择颜色**: 发送 `CMD_SINGLE_COLOR` (0x01)，包含 RGB 值。
- **切换到此模式**: 立即发送最后一次选择的颜色。

### B. 多色模式 (Mode 1)
- **切换到此模式**: 发送以下序列:
    1. `CMD_DYNAMIC_MODE` (0x05) - 动态/静态开关。
    2. `CMD_SYNC_MODE` (0x07) - 同步/独立开关。
    3. `CMD_MULTI_THEME` (0x06) - 选中的多色主题 (索引 1-10)。
- **切换动态开关 (Toggle Dynamic)**: 当用户切换"动态模式"时:
    1. 发送 `CMD_DYNAMIC_MODE`。
    2. **重新同步主题**: 立即重发 `CMD_MULTI_THEME`，确保设备正确进入动态效果。
- **选择主题**: 发送 `CMD_MULTI_THEME`。

### C. 律动模式 (Mode 2)
- **切换到此模式**: 发送以下序列:
    1. `CMD_RHYTHM_THEME` (0x24) - 选中的律动效果。
- **选择预设**: 发送 `CMD_RHYTHM_THEME`。

## 4. 分区亮度逻辑与优化
- **切换分区开关**:
    - **开启** (`isZoneMode = true`):
        1. 发送 `CMD_ZONE_BRIGHTNESS_SWITCH` (0x01 开启)。
        2. **重新同步数值**: 立即依次发送 **分区1、分区2 和 分区3** 的当前滑块数值。
    - **关闭** (`isZoneMode = false`):
        1. 发送 `CMD_ZONE_BRIGHTNESS_SWITCH` (0x00 关闭)。
        2. **同步总亮度**: 立即发送当前 **总亮度** 指令。
- **指令间隔优化 (解决方案)**:
    - **问题**: 在快速发送多个分区亮度指令时（如切换分区模式或连接同步），设备端可能会因为接收缓冲区溢出或处理不及时而丢包。
    - **解决**: 在连续发送亮度指令之间增加 **50毫秒** 的延时 (`Future.delayed`)。
    - **逻辑**:
      ```dart
      if (isZoneMode) {
        delay(50ms) -> 发送 Zone1 亮度
        delay(50ms) -> 发送 Zone2 亮度
        delay(50ms) -> 发送 Zone3 亮度
      }
      ```
- **滑块拖动**: 实时发送 `CMD_BRIGHTNESS` (针对特定分区或总亮度)。

## 5. 协议参考
| 功能 | 指令 ID | 描述 |
| :--- | :--- | :--- |
| 单色设置 | 0x01 | R, G, B |
| 分区开关 | 0x02 | 0x01=开启, 0x00=关闭 |
| 亮度设置 | 0x03 | 分区 ID + 数值 (0-10) |
| 总开关 | 0x04 | 0=关, 1=开, 2=跟随 |
| 动态模式 | 0x05 | 0=静态, 1=动态 |
| 多色主题 | 0x06 | 索引 1-10 |
| 同步模式 | 0x07 | 0=独立, 1=同步 |
| 律动主题 | 0x24 | 索引 1-8 |
